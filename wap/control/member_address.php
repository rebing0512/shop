<?php/** * 我的地址 * * * * */defined('TTShop') or exit('Access Invalid!');class member_addressControl extends mobileMemberControl {    public function __construct() {        parent::__construct();    }    /*    *我的收藏首页    */    public function indexOp() {         Tpl::output('web_seo',C('site_name').' - '.'地址管理');         Tpl::showpage('address_list');    }    public function address_syncOp(array $address)    {        if (!empty($address))        {            $data = [];            $data['appid'] = getAppId(C('app_alias'));            $data['userid'] = $this->member_info['weixin_unionid'];            $data['receiverName'] = $address['true_name'];            $data['city'] = $address['area_info'];            $data['detailAddress'] = $address['address'];            $data['phone'] = $address['mob_phone'];            $data['is_default'] = $address['is_default']==1?1:2;            $url = 'https://gateway.confolsc.com/services/address/shop/add?appid='.$data['appid'];            $resource = curlPost($url, $data);            return $resource;        }    }    /**     * 地址列表     */    public function address_listOp() {        $model_address = Model('address');        $address_list = $model_address->getAddressList(array('member_id'=>$this->member_info['member_id']));        output_data(array('address_list' => $address_list));    }    /*    *我的地址编辑    */    public function address_opera_editOp() {         Tpl::output('web_seo',C('site_name').' - '.'地址编辑');         Tpl::showpage('address_opera_edit');    }    /*    *我的地址添加    */    public function address_operaOp(){        Tpl::output('web_seo',C('site_name').' - '.'地址添加');        Tpl::showpage('address_opera');     }    /**     * 地址详细信息     */    public function address_infoOp() {        $address_id = intval($_POST['address_id']);        $model_address = Model('address');        $condition = array();        $condition['address_id'] = $address_id;        $address_info = $model_address->getAddressInfo($condition);        if(!empty($address_id) && $address_info['member_id'] == $this->member_info['member_id']) {            output_data(array('address_info' => $address_info));        } else {            output_error('地址不存在');        }    }    /**     * 删除地址     */    public function address_delOp() {        $address_id = intval($_POST['address_id']);        $model_address = Model('address');        $condition = array();        $condition['address_id'] = $address_id;        $condition['member_id'] = $this->member_info['member_id'];        $model_address->delAddress($condition);        output_data('1');    }    /**     * 新增地址     */    public function address_addOp() {        Model::beginTransaction();        try{            $model_address = Model('address');            $address_info = $this->_address_valid();            $result = $model_address->addAddress($address_info);            //address_info            $remote_result = json_decode($this->address_syncOp($address_info), 1);            if (!$remote_result || $remote_result['code'] != 1){                throw new Exception('地址中心保存失败！');            }            Model::commit();            output_data(array('address_id' => $result,'address_info'=>$address_info));        } catch (Exception $e) {            Model::rollback();            output_error('保存失败');        }    }    /**     * 编辑地址     */    public function address_editOp() {        $address_id = intval($_POST['address_id']);        $model_address = Model('address');        //验证地址是否为本人        $address_info = $model_address->getOneAddress($address_id);        if ($address_info['member_id'] != $this->member_info['member_id']) {            output_error('参数错误');        }        $address_info = $this->_address_valid();        $result = $model_address->editAddress($address_info, array('address_id' => $address_id));        if($result) {            output_data('1');        } else {            output_error('保存失败');        }    }    /**     * 验证地址数据     */    private function _address_valid() {        $obj_validate = new Validate();        $obj_validate->validateparam = array(            array("input"=>$_POST["true_name"],"require"=>"true","message"=>'姓名不能为空'),            array("input"=>$_POST["area_info"],"require"=>"true","message"=>'地区不能为空'),            array("input"=>$_POST["address"],"require"=>"true","message"=>'地址不能为空'),            array("input"=>$_POST['tel_phone'].$_POST['mob_phone'],'require'=>'true','message'=>'联系方式不能为空')        );        $error = $obj_validate->validate();        if ($error != ''){            output_error($error);        }        $data = array();        $data['member_id'] = $this->member_info['member_id'];        $data['true_name'] = $_POST['true_name'];        $data['area_id'] = intval($_POST['area_id']);        $data['city_id'] = intval($_POST['city_id']);        $data['area_info'] = $_POST['area_info'];        $data['address'] = $_POST['address'];        $data['tel_phone'] = $_POST['tel_phone'];        $data['mob_phone'] = $_POST['mob_phone'];		$data['is_default'] = $_POST['is_default'];        return $data;    }    /**     * 地区列表     */    public function area_listOp() {        $area_id = intval($_POST['area_id']);        $model_area = Model('area');        $condition = array();        if($area_id > 0) {            $condition['area_parent_id'] = $area_id;        } else {            $condition['area_deep'] = 1;        }        $area_list = $model_area->getAreaList($condition, 'area_id,area_name');        output_data(array('area_list' => $area_list));    }}